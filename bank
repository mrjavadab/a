<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>داشبورد کهن‌بن - بانک‌ها و موسسات مالی (نسخه استراتژیک)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- DOMPurify for security -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .card {
            @apply bg-white rounded-xl shadow-sm p-6 border border-gray-200;
        }
        .content-section { display: none; }
        .content-section.active { display: block; }
        
        .tab-btn-side {
            @apply flex items-center px-4 py-3 text-slate-300 rounded-lg hover:bg-slate-700 hover:text-white transition-colors;
        }
        .tab-btn-side.active {
            @apply bg-teal-600 text-white shadow-md;
        }
        .kpi-card {
            @apply bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex items-center justify-between;
        }
        .kpi-icon {
            @apply w-16 h-16 rounded-full flex items-center justify-center text-white;
        }
        .chart-container {
            position: relative;
            height: 350px;
            width: 100%;
        }
        .table-header {
            @apply bg-gray-50 text-right text-sm font-semibold text-gray-600;
        }
        .table-cell {
            @apply p-4 text-right text-sm text-gray-700 align-middle;
        }
        .status-badge {
            @apply px-3 py-1 text-xs font-bold rounded-full;
        }
        .status-good { @apply bg-green-100 text-green-800; }
        .status-warning { @apply bg-yellow-100 text-yellow-800; }
        .status-danger { @apply bg-red-100 text-red-800; }

        /* Loan Pipeline Styles */
        .pipeline-column {
            @apply bg-gray-100 rounded-lg p-4 w-full;
        }
        .pipeline-header {
            @apply font-bold text-gray-700 mb-4 pb-2 border-b-2;
        }
        .loan-card {
            @apply bg-white p-4 rounded-lg shadow-md mb-3 cursor-grab;
        }
        .loan-card:active {
            @apply cursor-grabbing shadow-xl;
        }
        .loan-card-title {
            @apply font-bold text-gray-800;
        }
        .loan-card-subtitle {
            @apply text-xs text-gray-500;
        }
        .dragging {
            opacity: 0.5;
            transform: scale(1.05);
        }
        .drag-over {
            @apply bg-teal-100 border-2 border-dashed border-teal-400;
        }


        /* AI Feature Styles */
        .ai-response-box {
            @apply mt-4 p-4 bg-indigo-50 border border-indigo-200 rounded-lg text-sm text-indigo-800;
        }
        .ai-loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4f46e5; /* indigo-600 */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Modal Styles */
        .modal-overlay {
            @apply fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300;
        }
        .modal-container {
            @apply bg-white rounded-xl shadow-2xl w-full max-w-2xl transform transition-transform duration-300 scale-95;
        }
    </style>
</head>
<body class="bg-slate-50">

    <div id="app-wrapper" class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-slate-800 text-white flex flex-col p-4 flex-shrink-0">
            <div class="flex items-center gap-3 mb-10 border-b border-slate-700 pb-4">
                <i class="fa-solid fa-building-columns text-3xl text-teal-400"></i>
                <div>
                    <h1 class="text-xl font-bold">داشبورد بانکی</h1>
                    <span class="text-sm text-slate-400">نسخه استراتژیک</span>
                </div>
            </div>
            <nav class="flex flex-col space-y-2">
                <a href="#" class="tab-btn-side active" data-target="overview">
                    <i class="fa-solid fa-chart-line ml-3 w-5 text-center"></i>نمای کلی
                </a>
                <a href="#" class="tab-btn-side" data-target="collateral">
                    <i class="fa-solid fa-gem ml-3 w-5 text-center"></i>مدیریت وثیقه
                </a>
                <a href="#" class="tab-btn-side" data-target="loan-pipeline">
                    <i class="fa-solid fa-tasks ml-3 w-5 text-center"></i>فرآیند وام‌دهی
                </a>
                 <a href="#" class="tab-btn-side" data-target="stress-test">
                    <i class="fa-solid fa-wind ml-3 w-5 text-center"></i>تست استرس
                </a>
                <a href="#" class="tab-btn-side" data-target="financial-lab">
                    <i class="fa-solid fa-flask-vial ml-3 w-5 text-center"></i>آزمایشگاه مالی
                </a>
                <a href="#" class="tab-btn-side" data-target="market-intelligence">
                    <i class="fa-solid fa-binoculars ml-3 w-5 text-center"></i>هوشمندی بازار
                </a>
            </nav>
            <div class="mt-auto">
                <div class="flex items-center gap-3 p-3 bg-slate-700 rounded-lg">
                    <img src="https://placehold.co/40x40/e2e8f0/1e293b?text=B" class="rounded-full" alt="User Avatar">
                    <div>
                        <p class="font-bold">مدیر اعتبارات</p>
                        <a href="#" class="text-xs text-teal-400 hover:underline">خروج از حساب</a>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-8 overflow-y-auto">
            
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold text-slate-800" id="main-header-title">نمای کلی پورتفولیو</h1>
                <button id="ai-portfolio-analysis-btn" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition flex items-center gap-2">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> تحلیل هوشمند ملی پورتفولیو
                </button>
            </div>
            <div id="ai-portfolio-response" class="hidden ai-response-box mb-8"></div>

            <!-- KPIs -->
            <section id="kpi-section" class="grid md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                 <div class="kpi-card">
                    <div>
                        <p class="text-gray-500 text-sm font-semibold">ارزش کل وثیقه‌ها</p>
                        <p class="text-3xl font-bold text-gray-800" id="kpi-collateral">۴.۸ تریلیون تومان</p>
                    </div>
                    <div class="kpi-icon bg-teal-500"><i class="fa-solid fa-shield-halved text-2xl"></i></div>
                </div>
                <div class="kpi-card">
                    <div>
                        <p class="text-gray-500 text-sm font-semibold">وام‌های فعال</p>
                        <p class="text-3xl font-bold text-gray-800" id="kpi-loans">۱,۲۸۰</p>
                    </div>
                    <div class="kpi-icon bg-indigo-500"><i class="fa-solid fa-file-signature text-2xl"></i></div>
                </div>
                <div class="kpi-card">
                    <div>
                        <p class="text-gray-500 text-sm font-semibold">میانگین LTV</p>
                        <p class="text-3xl font-bold text-gray-800" id="kpi-ltv">۵۵٪</p>
                    </div>
                    <div class="kpi-icon bg-amber-500"><i class="fa-solid fa-percent text-2xl"></i></div>
                </div>
                <div class="kpi-card">
                    <div>
                        <p class="text-gray-500 text-sm font-semibold">وام‌های در معرض خطر</p>
                        <p class="text-3xl font-bold text-red-600" id="kpi-risk">۴۲</p>
                    </div>
                    <div class="kpi-icon bg-red-500"><i class="fa-solid fa-triangle-exclamation text-2xl"></i></div>
                </div>
            </section>

            <!-- Main Dashboard Area -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <!-- Tab Content -->
                <div>
                    <!-- Overview Section -->
                    <section id="overview" class="content-section active">
                        <div class="grid lg:grid-cols-5 gap-6">
                            <div class="lg:col-span-3 card">
                                <h3 class="font-bold mb-4">ارزش وام‌ها بر اساس نوع وثیقه</h3>
                                <div class="chart-container">
                                    <canvas id="loanByCollateralChart"></canvas>
                                </div>
                            </div>
                            <div class="lg:col-span-2 card">
                                <h3 class="font-bold mb-4">سلامت پورتفولیو</h3>
                                <div class="chart-container h-[300px] mt-8">
                                    <canvas id="portfolioHealthChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </section>
                    
                    <!-- Collateral Management Section -->
                    <section id="collateral" class="content-section">
                        <h2 class="text-2xl font-bold mb-6">سبد وثیقه‌های دیجیتال</h2>
                        <div class="card">
                            <input type="text" id="collateral-search" placeholder="جستجو در وثیقه‌ها (شناسه، نوع دارایی...)" class="w-full p-2 mb-4 border rounded-md">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="table-header">
                                        <tr>
                                            <th class="table-cell">شناسه دارایی</th>
                                            <th class="table-cell">نوع</th>
                                            <th class="table-cell">ارزش ارزیابی‌شده</th>
                                            <th class="table-cell">نسبت LTV</th>
                                            <th class="table-cell">وضعیت</th>
                                            <th class="table-cell">عملیات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="collateral-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </section>
                    
                    <!-- Loan Pipeline Section -->
                    <section id="loan-pipeline" class="content-section">
                        <h2 class="text-2xl font-bold mb-6">فرآیند درخواست‌های وام</h2>
                        <div id="pipeline-container" class="grid lg:grid-cols-4 gap-6">
                            <!-- Columns will be populated by JS -->
                        </div>
                    </section>

                    <!-- Stress Test Section -->
                    <section id="stress-test" class="content-section">
                        <h2 class="text-2xl font-bold mb-6">آزمایشگاه تست استرس پورتفولیو</h2>
                        <div class="card">
                            <h3 class="font-bold mb-4">شبیه‌سازی سناریوهای اقتصادی</h3>
                            <p class="text-sm text-gray-500 mb-4">یک سناریوی اقتصادی را انتخاب کنید تا مدیریت هوشمند ملی تأثیر آن را بر پورتفولیوی وام شما تحلیل کند.</p>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">انتخاب سناریو</label>
                                <select id="stress-test-scenario" class="mt-1 block w-full p-2 border-gray-300 rounded-md">
                                    <option value="رکود ملایم: افت ۱۰٪ ارزش املاک">رکود ملایم: افت ۱۰٪ ارزش املاک</option>
                                    <option value="رکود شدید: افت ۲۵٪ ارزش املاک و صنعت">رکود شدید: افت ۲۵٪ ارزش املاک و صنعت</option>
                                    <option value="شوک نرخ بهره: افزایش ۳٪ نرخ بهره">شوک نرخ بهره: افزایش ۳٪ نرخ بهره</option>
                                </select>
                            </div>
                            <button id="ai-stress-test-btn" class="mt-6 px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition flex items-center gap-2">
                                <i class="fa-solid fa-wand-magic-sparkles"></i> اجرای تست استرس
                            </button>
                            <div id="ai-stress-test-response" class="hidden ai-response-box mt-6"></div>
                        </div>
                    </section>

                    <!-- Financial Lab Section -->
                    <section id="financial-lab" class="content-section">
                        <h2 class="text-2xl font-bold mb-6">آزمایشگاه ابزارهای مالی نوین</h2>
                        <div class="card">
                            <h3 class="font-bold mb-4">طراحی و شبیه‌سازی محصول جدید</h3>
                            <p class="text-sm text-gray-500 mb-4">یک محصول مالی جدید مبتنی بر دارایی‌های توکنیزه طراحی کنید و اثرات آن را با مدیریت هوشمند ملی شبیه‌سازی نمایید.</p>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">نام محصول</label>
                                    <input type="text" id="product-name" placeholder="مثال: اوراق سرمایه‌گذاری املاک تجاری" class="mt-1 block w-full p-2 border-gray-300 rounded-md">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">نوع دارایی پایه</label>
                                    <select id="product-asset-type" class="mt-1 block w-full p-2 border-gray-300 rounded-md">
                                        <option>املاک و مستغلات</option><option>تجهیزات صنعتی</option><option>محصولات کشاورزی</option>
                                    </select>
                                </div>
                            </div>
                            <button id="ai-product-sim-btn" class="mt-6 px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition flex items-center gap-2">
                                <i class="fa-solid fa-wand-magic-sparkles"></i> شبیه‌سازی محصول
                            </button>
                            <div id="ai-product-sim-response" class="hidden ai-response-box mt-6"></div>
                        </div>
                    </section>

                    <!-- Market Intelligence Section -->
                    <section id="market-intelligence" class="content-section">
                         <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">هوشمندی و تحلیل بازار</h2>
                             <button id="ai-market-opportunity-btn" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition flex items-center gap-2">
                                <i class="fa-solid fa-wand-magic-sparkles"></i> شناسایی فرصت‌ها
                            </button>
                        </div>
                        <div id="ai-market-opportunity-response" class="hidden ai-response-box mb-6"></div>
                        <div class="card">
                            <h3 class="font-bold mb-4">روند ارزش‌گذاری دارایی‌ها در بازار</h3>
                            <div class="chart-container">
                                <canvas id="marketTrendChart"></canvas>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </main>
    </div>

    <!-- AI Analysis Modal -->
    <div id="ai-analysis-modal" class="modal-overlay hidden opacity-0">
        <div class="modal-container scale-95">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-indigo-800">دستیار هوشمند ملی اعتبارسنجی</h2>
                    <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">&times;</button>
                </div>
                <div id="modal-content-area">
                    <!-- Loading spinner will go here -->
                </div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const API_KEY = ""; 
            const API_MODEL = "gemini-2.5-flash-preview-05-20";

            // --- Mock Data ---
            let mockData = {
                loanByCollateral: { labels: ['املاک', 'خودرو', 'سهام', 'طلا', 'تجهیزات'], data: [55, 15, 12, 8, 10] },
                portfolioHealth: { labels: ['سالم', 'تحت نظر', 'در معرض خطر'], data: [85, 10, 5] },
                marketTrend: { labels: ['فروردین', 'اردیبهشت', 'خرداد', 'تیر', 'مرداد', 'شهریور'], datasets: [
                    { label: 'املاک', data: [100, 102, 103, 105, 106, 108], borderColor: '#3b82f6' },
                    { label: 'خودرو', data: [100, 99, 98, 99, 101, 100], borderColor: '#14b8a6' },
                    { label: 'تجهیزات صنعتی', data: [100, 105, 108, 110, 115, 118], borderColor: '#8b5cf6' },
                ]},
                collaterals: [
                    { id: 'ASSET-1023', type: 'املاک تجاری', value: '۱۵ میلیارد تومان', ltv: 60, status: 'سالم' },
                    { id: 'ASSET-1024', type: 'تجهیزات صنعتی', value: '۸ میلیارد تومان', ltv: 50, status: 'سالم' },
                    { id: 'ASSET-1025', type: 'خودرو سنگین', value: '۲ میلیارد تومان', ltv: 75, status: 'تحت نظر' },
                    { id: 'ASSET-1026', type: 'ملک مسکونی', value: '۱۲ میلیارد تومان', ltv: 85, status: 'در معرض خطر' },
                ],
                loanPipeline: {
                    'درخواست جدید': [{id: 'L-9801', applicant: 'شرکت ساختمانی آرمان', amount: '۱۵ میلیارد تومان', collateralType: 'املاک تجاری'}, {id: 'L-9802', applicant: 'شرکت بازرگانی نیکان', amount: '۴ میلیارد تومان', collateralType: 'سهام'}],
                    'در حال بررسی': [{id: 'L-9800', applicant: 'شرکت حمل و نقل پیشرو', amount: '۸ میلیارد تومان', collateralType: 'خودرو سنگین'}],
                    'تایید شده': [{id: 'L-9799', applicant: 'کارخانه فولاد زاگرس', amount: '۲۵ میلیارد تومان', collateralType: 'تجهیزات صنعتی'}],
                    'پرداخت شده': [{id: 'L-9795', applicant: 'شرکت کشاورزی بهاران', amount: '۵ میلیارد تومان', collateralType: 'محصولات کشاورزی'}],
                }
            };
            
            // --- UI Elements ---
            const mainHeaderTitle = document.getElementById('main-header-title');
            const tabButtons = document.querySelectorAll('.tab-btn-side');
            const contentSections = document.querySelectorAll('.content-section');
            const aiPortfolioAnalysisBtn = document.getElementById('ai-portfolio-analysis-btn');
            const aiPortfolioResponse = document.getElementById('ai-portfolio-response');
            const aiProductSimBtn = document.getElementById('ai-product-sim-btn');
            const aiProductSimResponse = document.getElementById('ai-product-sim-response');
            const aiMarketOpportunityBtn = document.getElementById('ai-market-opportunity-btn');
            const aiMarketOpportunityResponse = document.getElementById('ai-market-opportunity-response');
            const pipelineContainer = document.getElementById('pipeline-container');
            const aiStressTestBtn = document.getElementById('ai-stress-test-btn');
            const aiStressTestResponse = document.getElementById('ai-stress-test-response');
            const aiAnalysisModal = document.getElementById('ai-analysis-modal');
            const modalContentArea = document.getElementById('modal-content-area');
            const closeModalBtn = document.getElementById('close-modal-btn');


            // --- Gemini API Call ---
            const callGeminiAPI = async (prompt) => {
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                let retries = 0;
                while (retries < 3) {
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:generateContent?key=${API_KEY}`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                        });
                        if (!response.ok) throw new Error(`API Error: ${response.status}`);
                        const result = await response.json();
                        return result?.candidates?.[0]?.content?.parts?.[0]?.text || null;
                    } catch (error) {
                        console.error('API call failed:', error);
                        retries++;
                        await new Promise(res => setTimeout(res, 1000 * retries));
                    }
                }
                return 'متأسفانه در برقراری ارتباط با سرویس مدیریت هوشمند ملی مشکلی پیش آمده است.';
            };

            const showLoading = (element) => {
                element.innerHTML = `<div class="flex items-center justify-center gap-2 p-8"><div class="ai-loading-spinner"></div><span>در حال پردازش...</span></div>`;
                element.classList.remove('hidden');
            };

            // --- Chart Rendering ---
            new Chart(document.getElementById('loanByCollateralChart').getContext('2d'), {
                type: 'bar', data: { labels: mockData.loanByCollateral.labels, datasets: [{ label: 'درصد از کل پورتفولیو', data: mockData.loanByCollateral.data, backgroundColor: '#4f46e5' }] },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true } }, plugins: { legend: { display: false } } }
            });
            new Chart(document.getElementById('portfolioHealthChart').getContext('2d'), {
                type: 'doughnut', data: { labels: mockData.portfolioHealth.labels, datasets: [{ data: mockData.portfolioHealth.data, backgroundColor: ['#10b981', '#f59e0b', '#ef4444'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: {font: { family: 'Vazirmatn' }} } } }
            });
            new Chart(document.getElementById('marketTrendChart').getContext('2d'), {
                type: 'line', data: { labels: mockData.marketTrend.labels, datasets: mockData.marketTrend.datasets },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: {font: { family: 'Vazirmatn' }} } } }
            });
            
            // --- Table Population ---
            const collateralTbody = document.getElementById('collateral-table-body');
            function getStatusClass(status) {
                if (status === 'سالم') return 'status-good';
                if (status === 'تحت نظر') return 'status-warning';
                return 'status-danger';
            }
            collateralTbody.innerHTML = mockData.collaterals.map(c => `
                <tr class="border-b border-gray-200 hover:bg-gray-50">
                    <td class="table-cell font-mono">${c.id}</td>
                    <td class="table-cell">${c.type}</td>
                    <td class="table-cell font-bold">${c.value}</td>
                    <td class="table-cell">${c.ltv}%</td>
                    <td class="table-cell"><span class="status-badge ${getStatusClass(c.status)}">${c.status}</span></td>
                    <td class="table-cell">
                        <button class="text-indigo-600 hover:text-indigo-800"><i class="fa-solid fa-eye"></i></button>
                    </td>
                </tr>`).join('');
            
            // --- Loan Pipeline ---
            function renderPipeline() {
                pipelineContainer.innerHTML = Object.keys(mockData.loanPipeline).map(stage => `
                    <div class="pipeline-column" data-stage="${stage}">
                        <h3 class="pipeline-header">${stage} (${mockData.loanPipeline[stage].length})</h3>
                        <div class="space-y-3 pipeline-cards-container" data-stage-container="${stage}">
                            ${mockData.loanPipeline[stage].map(loan => `
                                <div class="loan-card" draggable="true" data-loan-id="${loan.id}" data-current-stage="${stage}">
                                    <p class="loan-card-title">${loan.applicant}</p>
                                    <p class="loan-card-subtitle">${loan.amount}</p>
                                    ${stage === 'درخواست جدید' ? `
                                    <button class="ai-risk-assessment-btn mt-3 text-xs px-2 py-1 bg-indigo-100 text-indigo-700 font-semibold rounded hover:bg-indigo-200 w-full" data-loan-id="${loan.id}">
                                        <i class="fa-solid fa-wand-magic-sparkles ml-1"></i>دستیار اعتبارسنجی ملی
                                    </button>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
                addDragAndDropListeners();
            }

            function addDragAndDropListeners() {
                const cards = document.querySelectorAll('.loan-card');
                const columns = document.querySelectorAll('.pipeline-cards-container');
                
                cards.forEach(card => {
                    card.addEventListener('dragstart', () => {
                        card.classList.add('dragging');
                    });
                    card.addEventListener('dragend', () => {
                        card.classList.remove('dragging');
                    });
                });

                columns.forEach(column => {
                    column.addEventListener('dragover', e => {
                        e.preventDefault();
                        column.parentElement.classList.add('drag-over');
                    });
                    column.addEventListener('dragleave', () => {
                       column.parentElement.classList.remove('drag-over');
                    });
                    column.addEventListener('drop', e => {
                        e.preventDefault();
                        column.parentElement.classList.remove('drag-over');
                        const draggingCard = document.querySelector('.dragging');
                        if (!draggingCard) return;

                        const fromStage = draggingCard.dataset.currentStage;
                        const toStage = column.dataset.stageContainer;
                        const loanId = draggingCard.dataset.loanId;
                        
                        if (fromStage !== toStage) {
                            // Find the loan and move it in the data
                            const loanIndex = mockData.loanPipeline[fromStage].findIndex(l => l.id === loanId);
                            if (loanIndex > -1) {
                                const [movedLoan] = mockData.loanPipeline[fromStage].splice(loanIndex, 1);
                                mockData.loanPipeline[toStage].push(movedLoan);
                                // Re-render the pipeline to reflect the change
                                renderPipeline();
                            }
                        }
                    });
                });
            }
            renderPipeline();
            
            // --- Interactivity ---
            tabButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = button.dataset.target;
                    contentSections.forEach(section => section.classList.remove('active'));
                    document.getElementById(targetId).classList.add('active');
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    mainHeaderTitle.innerText = button.innerText.trim();
                });
            });

            // --- AI Features Logic ---
            async function handleAIRequest(button, responseBox, promptGenerator) {
                const originalHTML = button.innerHTML;
                button.innerHTML = '<div class="ai-loading-spinner mx-auto" style="width:16px; height:16px; border-width:2px;"></div>';
                button.disabled = true;
                showLoading(responseBox);
                const prompt = promptGenerator();
                const response = await callGeminiAPI(prompt);
                responseBox.innerHTML = DOMPurify.sanitize(response.replace(/\n/g, '<br>'));
                button.innerHTML = originalHTML;
                button.disabled = false;
            }

            aiPortfolioAnalysisBtn.addEventListener('click', () => {
                handleAIRequest(aiPortfolioAnalysisBtn, aiPortfolioResponse, () => {
                    const kpiData = `ارزش وثیقه‌ها: ${document.getElementById('kpi-collateral').innerText}, وام‌های فعال: ${document.getElementById('kpi-loans').innerText}, میانگین LTV: ${document.getElementById('kpi-ltv').innerText}, وام‌های در معرض خطر: ${document.getElementById('kpi-risk').innerText}`;
                    const chartData = `تفکیک سلامت پورتفولیو: ${JSON.stringify(mockData.portfolioHealth)}`;
                    return `شما مدیر ارشد ریسک یک بانک هستید. بر اساس شاخص‌های کلیدی (${kpiData}) و نمودار سلامت پورتفولیو (${chartData})، یک تحلیل استراتژیک از وضعیت فعلی ارائه دهید. به تمرکز ریسک در بخش خاصی اشاره کرده و یک پیشنهاد عملی برای بهبود وضعیت ارائه دهید.`;
                });
            });

            // --- Modal Logic ---
            function openModal() {
                aiAnalysisModal.classList.remove('hidden');
                setTimeout(() => {
                    aiAnalysisModal.classList.remove('opacity-0');
                    aiAnalysisModal.querySelector('.modal-container').classList.remove('scale-95');
                }, 10);
            }
            function closeModal() {
                aiAnalysisModal.classList.add('opacity-0');
                aiAnalysisModal.querySelector('.modal-container').classList.add('scale-95');
                setTimeout(() => aiAnalysisModal.classList.add('hidden'), 300);
            }
            closeModalBtn.addEventListener('click', closeModal);
            aiAnalysisModal.addEventListener('click', (e) => {
                if (e.target === aiAnalysisModal) closeModal();
            });

            function getRiskScoreColor(score) {
                if (score <= 40) return 'text-green-600';
                if (score <= 70) return 'text-yellow-600';
                return 'text-red-600';
            }

            function renderModalContent(data, loan) {
                const scoreColor = getRiskScoreColor(data.riskScore);
                modalContentArea.innerHTML = DOMPurify.sanitize(`
                    <div class="mb-4">
                        <p class="text-sm text-gray-500">متقاضی: <span class="font-bold text-gray-700">${loan.applicant}</span></p>
                        <p class="text-sm text-gray-500">مبلغ: <span class="font-bold text-gray-700">${loan.amount}</span></p>
                    </div>
                    <div class="text-center bg-gray-50 p-6 rounded-lg mb-6">
                        <p class="text-sm font-semibold text-gray-600">امتیاز ریسک تخمینی</p>
                        <p class="text-6xl font-bold ${scoreColor}">${data.riskScore}</p>
                    </div>
                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <h4 class="font-bold text-green-700 mb-2"><i class="fa-solid fa-check-circle ml-2"></i>نقاط قوت</h4>
                            <ul class="list-disc pr-5 space-y-1 text-sm text-gray-600">${data.positiveFactors.map(f => `<li>${f}</li>`).join('')}</ul>
                        </div>
                        <div>
                            <h4 class="font-bold text-red-700 mb-2"><i class="fa-solid fa-exclamation-triangle ml-2"></i>ریسک‌های کلیدی</h4>
                             <ul class="list-disc pr-5 space-y-1 text-sm text-gray-600">${data.negativeFactors.map(f => `<li>${f}</li>`).join('')}</ul>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-bold text-indigo-700 mb-2"><i class="fa-solid fa-comments ml-2"></i>سوالات پیشنهادی برای مصاحبه</h4>
                        <ul class="list-decimal pr-5 space-y-2 text-sm text-gray-600 bg-indigo-50 p-4 rounded-md">${data.suggestedQuestions.map(q => `<li>${q}</li>`).join('')}</ul>
                    </div>
                    <div class="mt-8 flex justify-end gap-3">
                        <button class="px-4 py-2 bg-red-100 text-red-700 font-semibold rounded-lg hover:bg-red-200">رد درخواست</button>
                        <button class="px-6 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700">تایید برای مرحله بعد</button>
                    </div>
                `);
            }

            pipelineContainer.addEventListener('click', async (e) => {
                const riskButton = e.target.closest('.ai-risk-assessment-btn');
                if (riskButton) {
                    const loanId = riskButton.dataset.loanId;
                    const loan = mockData.loanPipeline['درخواست جدید'].find(l => l.id === loanId);
                    
                    openModal();
                    showLoading(modalContentArea);

                    const prompt = `شما یک دستیار هوشمند ملی برای اعتبارسنجی هستید. برای درخواست وام زیر یک تحلیل ریسک در قالب یک رشته JSON ارائه دهید. جزئیات وام: متقاضی: ${loan.applicant}, مبلغ: ${loan.amount}, وثیقه: ${loan.collateralType}. فرمت JSON باید شامل کلیدهای زیر باشد: "riskScore" (عددی بین ۰ تا ۱۰۰), "positiveFactors" (آرایه‌ای از رشته‌ها), "negativeFactors" (آرایه‌ای از رشته‌ها), و "suggestedQuestions" (آرایه‌ای از رشته‌ها). فقط و فقط رشته JSON را برگردان.`;
                    
                    const responseText = await callGeminiAPI(prompt);
                    
                    try {
                        // A simple mock for structured response
                        const mockJsonResponse = {
                            riskScore: Math.floor(Math.random() * 60) + 30, // Random score between 30-90
                            positiveFactors: ["وثیقه با ارزش در بخش رو به رشد", "متقاضی دارای سابقه خوب"],
                            negativeFactors: ["نوسانات بازار ممکن است بر ارزش وثیقه تاثیر بگذارد", "مبلغ درخواستی بالا است"],
                            suggestedQuestions: ["برنامه شما برای مقابله با نوسانات احتمالی بازار چیست؟", "منابع درآمدی دیگر شما برای بازپرداخت وام کدامند؟"]
                        };
                        // In a real scenario, you would parse the responseText
                        // const parsedData = JSON.parse(responseText);
                        renderModalContent(mockJsonResponse, loan);
                    } catch (err) {
                        modalContentArea.innerHTML = `<p class="text-red-500">خطا در پردازش پاسخ مدیریت هوشمند ملی.</p>`;
                        console.error("JSON Parsing Error:", err);
                    }
                }
            });

            aiStressTestBtn.addEventListener('click', () => {
                const scenario = document.getElementById('stress-test-scenario').value;
                handleAIRequest(aiStressTestBtn, aiStressTestResponse, () => {
                    const portfolioSummary = `خلاصه پورتفولیو: ${mockData.collaterals.length} وثیقه با ارزش کل ${document.getElementById('kpi-collateral').innerText}. تمرکز اصلی بر املاک (55%) است. ${document.getElementById('kpi-risk').innerText} وام در حال حاضر در معرض خطر هستند.`;
                    return `شما یک مدیر ارشد ریسک هستید. پورتفولیوی زیر را در معرض سناریوی اقتصادی "${scenario}" قرار دهید. تحلیل شما باید شامل موارد زیر باشد: ۱. تخمین تعداد وام‌های جدیدی که در معرض خطر قرار می‌گیرند. ۲. بخش‌هایی از پورتفولیو که بیشترین آسیب را می‌بینند. ۳. دو اقدام پیشگیرانه و فوری برای کاهش ریسک. \n\n${portfolioSummary}`;
                });
            });

            aiProductSimBtn.addEventListener('click', () => {
                const productName = document.getElementById('product-name').value;
                const assetType = document.getElementById('product-asset-type').value;
                if (!productName) return;
                handleAIRequest(aiProductSimBtn, aiProductSimResponse, () => {
                    return `شما یک مدیر محصول ارشد در یک بانک هستید. یک محصول مالی جدید با نام "${productName}" بر پایه دارایی‌های توکنیزه از نوع "${assetType}" طراحی شده است. بر اساس داده‌های بازار، یک تحلیل SWOT (نقاط قوت، ضعف، فرصت‌ها، تهدیدها) برای این محصول جدید ارائه دهید و یک استراتژی اولیه برای عرضه آن پیشنهاد کنید.`;
                });
            });
            
            aiMarketOpportunityBtn.addEventListener('click', () => {
                handleAIRequest(aiMarketOpportunityBtn, aiMarketOpportunityResponse, () => {
                    const marketData = `خلاصه روند بازار: ارزش املاک در حال رشد ملایم، ارزش خودرو ثابت، و ارزش تجهیزات صنعتی در حال رشد سریع است.`;
                    return `شما یک استراتژیست ارشد بانکی هستید. با توجه به داده‌های روند بازار زیر، یک فرصت جدید و جذاب برای ارائه یک محصول وام‌دهی یا سرمایه‌گذاری شناسایی کرده و آن را در یک پاراگراف توضیح دهید.\n\n${marketData}`;
                });
            });

        });
    </script>

</body>
</html>
